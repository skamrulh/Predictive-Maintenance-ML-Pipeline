# GitHub Actions Workflow for Predictive Maintenance Pipeline

name: CI Pipeline
# Triggers the workflow on push or pull request events to the main branch.
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build_train_test:
    # Runs on the latest Ubuntu image
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Create necessary directories (data, models, artifacts)
      run: mkdir data models artifacts

    # 1. Run the entire pipeline (Data Generation, Training, Evaluation)
    - name: üöÄ Run Data Generation
      run: python generate_synthetic_data.py
      
    - name: üß† Train Classification Model
      run: python train_classification.py
      
    - name: üß† Train RUL Model
      run: python train_rul.py

    - name: ‚úÖ Evaluate Classification Model
      run: python evaluate_classification.py
      
    - name: ‚úÖ Evaluate RUL Model
      run: python evaluate_rul.py

    # 2. Test API (Sanity Check)
    - name: üß™ Run API Health Check (with Wait)
      # 1. Start Uvicorn in the background.
      # 2. Use a loop to repeatedly check the service until it responds (max 20 attempts).
      # nohup uvicorn api:app --host 0.0.0.0 --port 8000 &
      run: |
        # Start Uvicorn in the background using the correct path and port
        uvicorn api:app --host 0.0.0.0 --port 8000 & 
        sleep 5
        - name: Health check
        run: curl http://localhost:8000/health
        
        echo "Waiting for API to start on port 8000..."
        MAX_ATTEMPTS=20
        ATTEMPTS=0
        while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
            # Try to connect, suppressing output/errors
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)
            if [ "$STATUS" -eq 200 ]; then
                echo "API is ready! (Status 200)"
                break
            fi
            ATTEMPTS=$((ATTEMPTS + 1))
            echo "Attempt $ATTEMPTS/$MAX_ATTEMPTS: Status $STATUS. Waiting 1 second..."
            sleep 1
        done

        if [ $ATTEMPTS -eq $MAX_ATTEMPTS ]; then
            echo "‚ùå API failed to start after $MAX_ATTEMPTS attempts."
            exit 1
        fi
        
        echo "Final API test: Checking root endpoint /"
        curl -X GET http://localhost:8000/
      shell: bash

    - name: Archive Metrics Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: model-metrics
        path: artifacts/
        retention-days: 7
